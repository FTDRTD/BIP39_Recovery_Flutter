name: Flutter CI/CD - Android, Windows, Linux, macOS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"  # è‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬

      - name: ç¼“å­˜ Flutter ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/flutter
          key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}

      - name: å®‰è£…ä¾èµ–
        run: flutter pub get

      - name: è®¾ç½® Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "adopt"

      - name: æ„å»º Android APK
        run: flutter build apk --release

      - name: ä¸Šä¼  Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 5

  build-macos:
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable" # è‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬

      - name: ç¼“å­˜ Flutter ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/flutter
          key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}

      - name: å®‰è£…ä¾èµ–
        run: flutter pub get

      - name: å¯ç”¨ macOS æ¡Œé¢æ”¯æŒ
        run: flutter config --enable-macos-desktop

      - name: æ„å»º macOS åº”ç”¨ç¨‹åº
        run: flutter build macos --release

      - name: åˆ›å»º macOS å‹ç¼©åŒ…
        run: |
          cd build/macos/Build/Products/Release
          tar -czf ../../../../../macos-release.tar.gz *.app

      - name: ä¸Šä¼  macOS åº”ç”¨ç¨‹åº
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: macos-release.tar.gz
          retention-days: 5

  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"  # è‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬

      - name: ç¼“å­˜ Flutter ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/flutter
          key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}

      - name: å®‰è£…ä¾èµ–
        run: flutter pub get

      - name: å¯ç”¨ Windows æ¡Œé¢æ”¯æŒ
        run: flutter config --enable-windows-desktop

      - name: æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
        run: flutter build windows --release

      - name: åˆ›å»º Windows å‹ç¼©åŒ…
        run: |
          cd build/windows/x64/runner/Release
          Compress-Archive -Path * -DestinationPath ../../../../../windows-release.zip
        shell: powershell

      - name: ä¸Šä¼  Windows å¯æ‰§è¡Œæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: windows-release.zip
          retention-days: 5

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"  # è‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬

      - name: å®‰è£… Linux ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: ç¼“å­˜ Flutter ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/flutter
          key: flutter-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}

      - name: å®‰è£…ä¾èµ–
        run: flutter pub get

      - name: å¯ç”¨ Linux æ¡Œé¢æ”¯æŒ
        run: flutter config --enable-linux-desktop

      - name: æ„å»º Linux å¯æ‰§è¡Œæ–‡ä»¶
        run: flutter build linux --release

      - name: åˆ›å»º Linux å‹ç¼©åŒ…
        run: |
          cd build/linux/x64/release/bundle
          tar -czf ../../../../../linux-release.tar.gz *

      - name: ä¸Šä¼  Linux å¯æ‰§è¡Œæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: linux-executable
          path: linux-release.tar.gz
          retention-days: 5

  create-release:
    needs: [build-android, build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶ (è°ƒè¯•ç”¨)
        run: find artifacts -type f -ls

      - name: è·å–åº”ç”¨ç‰ˆæœ¬
        id: get_version
        run: |
          if [ ! -f pubspec.yaml ]; then
            echo "âŒ pubspec.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | tr -d '\r' | cut -d'+' -f1)
          
          if [ -z "$VERSION" ]; then
            echo "âŒ æ— æ³•ä» pubspec.yaml ä¸­è·å–ç‰ˆæœ¬å·"
            echo "è¯·ç¡®ä¿ pubspec.yaml ä¸­åŒ…å«ç±»ä¼¼ 'version: 1.0.0' çš„è¡Œ"
            exit 1
          fi
          
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "âœ… æ‰¾åˆ°ç‰ˆæœ¬å·: $VERSION"

      - name: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ release
        id: check_release
        continue-on-error: true
        run: |
          echo "ğŸ” æ£€æŸ¥ç‰ˆæœ¬ v${{ env.APP_VERSION }} æ˜¯å¦å·²å­˜åœ¨..."
          
          if gh release view "v${{ env.APP_VERSION }}" >/dev/null 2>&1; then
            echo "âš ï¸ Release v${{ env.APP_VERSION }} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
            echo "skip_release=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release v${{ env.APP_VERSION }} ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»º"
            echo "skip_release=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: éªŒè¯å·¥ä»¶æ–‡ä»¶
        run: |
          echo "ğŸ“¦ éªŒè¯ä¸‹è½½çš„å·¥ä»¶æ–‡ä»¶..."
          
          # æ£€æŸ¥ Android APK
          if [ -f "artifacts/android-apk/app-release.apk" ]; then
            echo "âœ… Android APK æ–‡ä»¶å­˜åœ¨: $(ls -lh artifacts/android-apk/app-release.apk)"
          else
            echo "âŒ Android APK æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ Windows ZIP
          if [ -f "artifacts/windows-exe/windows-release.zip" ]; then
            echo "âœ… Windows ZIP æ–‡ä»¶å­˜åœ¨: $(ls -lh artifacts/windows-exe/windows-release.zip)"
          else
            echo "âŒ Windows ZIP æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ Linux TAR.GZ
          if [ -f "artifacts/linux-executable/linux-release.tar.gz" ]; then
            echo "âœ… Linux TAR.GZ æ–‡ä»¶å­˜åœ¨: $(ls -lh artifacts/linux-executable/linux-release.tar.gz)"
          else
            echo "âŒ Linux TAR.GZ æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ macOS TAR.GZ
          if [ -f "artifacts/macos-app/macos-release.tar.gz" ]; then
            echo "âœ… macOS TAR.GZ æ–‡ä»¶å­˜åœ¨: $(ls -lh artifacts/macos-app/macos-release.tar.gz)"
          else
            echo "âŒ macOS TAR.GZ æ–‡ä»¶ä¸å­˜åœ¨"
          fi

      - name: åˆ›å»ºå¹¶ä¸Šä¼ å‘è¡Œç‰ˆ
        if: steps.check_release.outputs.skip_release != 'true'
        run: |
          echo "ğŸš€ å¼€å§‹åˆ›å»º Release v${{ env.APP_VERSION }}..."
          
          # å‡†å¤‡å‘å¸ƒæ–‡ä»¶åˆ—è¡¨
          FILES=""
          if [ -f "artifacts/android-apk/app-release.apk" ]; then
            FILES="$FILES artifacts/android-apk/app-release.apk"
          fi
          if [ -f "artifacts/windows-exe/windows-release.zip" ]; then
            FILES="$FILES artifacts/windows-exe/windows-release.zip"
          fi
          if [ -f "artifacts/linux-executable/linux-release.tar.gz" ]; then
            FILES="$FILES artifacts/linux-executable/linux-release.tar.gz"
          fi
          if [ -f "artifacts/macos-app/macos-release.tar.gz" ]; then
            FILES="$FILES artifacts/macos-app/macos-release.tar.gz"
          fi
          
          if [ -z "$FILES" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯å‘å¸ƒçš„æ–‡ä»¶"
            exit 1
          fi
          
          echo "ğŸ“ å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶: $FILES"
          
          # åˆ›å»º Release
          gh release create "v${{ env.APP_VERSION }}" \
            --title "Release v${{ env.APP_VERSION }}" \
            --notes "ğŸ‰ è‡ªåŠ¨æ„å»ºå‘å¸ƒ v${{ env.APP_VERSION }}

## ğŸ“¦ åŒ…å«çš„å¹³å°
- ğŸ¤– **Android APK** - é€‚ç”¨äº Android è®¾å¤‡
- ğŸªŸ **Windows ZIP** - é€‚ç”¨äº Windows æ¡Œé¢
- ğŸ§ **Linux TAR.GZ** - é€‚ç”¨äº Linux æ¡Œé¢
- ğŸ **macOS TAR.GZ** - é€‚ç”¨äº macOS æ¡Œé¢

## ğŸ”¨ æ„å»ºä¿¡æ¯
- **æ„å»ºæ—¶é—´**: $(date)
- **æäº¤**: ${{ github.sha }}
- **åˆ†æ”¯**: ${{ github.ref_name }}

*æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*" \
            $FILES
            
          echo "âœ… Release v${{ env.APP_VERSION }} åˆ›å»ºæˆåŠŸï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}